#! /bin/bash
set -e

SOURCE_DIR=$(realpath $(dirname $0))
SCRIPTS_DIR=$SOURCE_DIR/bin/
AUR_FILE=$SOURCE_DIR/dependencies/aur.txt
CRATES_FILE=$SOURCE_DIR/dependencies/cargo.txt

CACHE_DIR=/var/iukbtw/cache
CACHE_DIR_CARGO=${CACHE_DIR}/cargo
TMP_DIR_PARU=/tmp/paru-install-$RANDOM

STAGING_DIR=/tmp/iukbtw_install_staging/
INSTALL_DIR=/usr/bin/iukbtw/


title () { printf "\e[92;1;4m$1\e[0m\n" ; }
progress () { printf "\e[32m$1\e[0m\n" ; }
info () { printf "\e[36m$1\e[0m\n" ; }
notice () { printf "\e[35m$1\e[0m\n" ; }
warn () { printf "\e[93;1m$1\e[0m\n" ; }
error () { printf "\e[31m$1\e[0m\n" ; }

title "Installation script for iukbtw"
echo "Install packages, binaries, and scripts required for iukbtw.
Packages are installed from the AUR. Cargo binary crates are downloaded and
installed along with scripts."
echo
progress "Installation details:"
printf "AUR packages file: "; info "$AUR_FILE"
printf "Cargo crates file: "; info "$CRATES_FILE"
printf "Scripts directory: "; info "$SCRIPTS_DIR"
printf "Installation directory: "; info "$INSTALL_DIR"
echo
warn "System will be updated and installation directory will be cleared."
notice "Start installation? (y/N)"
read -sn 1 $timeout prompt_start || :
echo
[[ -n $prompt_start && "yY" == *$prompt_start* ]] || exit 1

sudo -v


ensure_dir() {
    set -e
    [[ -d $1 ]] || sudo mkdir --parents $1
}
recreate_dir () {
    set -e
    [[ ! -e $1 ]] || sudo rm -r $1
    ensure_dir $1
}


ensure_dir $CACHE_DIR && sudo chown 0 $CACHE_DIR
recreate_dir $STAGING_DIR && sudo chown 0 $STAGING_DIR


if [[ ! $(command -v paru) ]]; then
    progress "=> Installing paru..."
    recreate_dir $TMP_DIR_PARU
    sudo chown $USER $TMP_DIR_PARU
    sudo pacman -S --quiet --needed --noconfirm base-devel git
    git clone --quiet --depth 1 --shallow-submodules https://aur.archlinux.org/paru.git $TMP_DIR_PARU
    cd $TMP_DIR_PARU
    makepkg -si --needed --noconfirm
fi


progress "=> Installing AUR dependencies..."
paru -S --quiet --needed --noconfirm $(cat $AUR_FILE)


progress "=> Staging binary crates from cargo..."
sudo cargo install --root $CACHE_DIR_CARGO $(cat $CRATES_FILE)
echo "The above warning regarding $CACHE_DIR_CARGO is irrelevant, as it is only the cache directory. See installation directory below (at the end of the script)."
sudo cp -t $STAGING_DIR $CACHE_DIR_CARGO/bin/*


progress "=> Staging scripts..."
sudo cp -rt $STAGING_DIR $SCRIPTS_DIR/*
sudo find $STAGING_DIR -type f -name "*.*" -execdir bash -c 'mv "$0" "${0%.*}"' {} \;


progress "=> Installing binaries..."
recreate_dir $INSTALL_DIR
sudo chown 0 $INSTALL_DIR
sudo cp -rt $INSTALL_DIR $STAGING_DIR/*
sudo chmod +x --recursive $INSTALL_DIR


progress "=> Cleaning up installation files..."
sudo rm -rf $STAGING_DIR


progress "=> Installed iukbtw."
echo -n "Scripts and binaries installed to: "; info "$INSTALL_DIR"
notice "Be sure to add the installation directory to your PATH."
