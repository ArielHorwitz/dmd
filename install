#! /bin/bash
set -e

SOURCE_DIR=$(realpath $(dirname $0))
SCRIPTS_DIR=$SOURCE_DIR/bin/
AUR_FILE=$SOURCE_DIR/data/deps-aur.txt
CRATES_FILE=$SOURCE_DIR/data/deps-rust.txt

CACHE_DIR=/var/iukbtw/cache
CACHE_DIR_CARGO=${CACHE_DIR}/cargo
CACHE_DIR_PARU=${CACHE_DIR}/paru

STAGING_DIR=/tmp/iukbtw_install_staging/
INSTALL_DIR=/bin/iukbtw/


title () { printf "\e[92;1;4m$1\e[0m\n" ; }
progress () { printf "\e[32m$1\e[0m\n" ; }
info () { printf "\e[36m$1\e[0m\n" ; }
notice () { printf "\e[35m$1\e[0m\n" ; }
warn () { printf "\e[93;1m$1\e[0m\n" ; }
error () { printf "\e[31m$1\e[0m\n" ; }
checkroot() {
    if [[ ! $EUID -eq 0 ]]; then
        error "Must be run as root."
        exit 1
    fi
}

title "Installation script for iukbtw"
echo "Install packages, binaries, and scripts required for iukbtw.
Packages are installed from the AUR. Cargo binary crates are downloaded and
installed along with scripts."
echo
progress "Installation details:"
printf "AUR packages file: "; info "$AUR_FILE"
printf "Cargo crates file: "; info "$CRATES_FILE"
printf "Scripts directory: "; info "$SCRIPTS_DIR"
printf "Installation directory: "; info "$INSTALL_DIR"
echo
warn "Installation directory will be cleared!"
checkroot
notice "Start installation? (y/N)"
read -sn 1 $timeout prompt_start || :
echo
[[ -n $prompt_start && "yY" == *$prompt_start* ]] || exit 1


ensure_dir() {
    set -e
    [[ -d $1 ]] || mkdir --parents $1
    chown 0 $1
}
recreate_dir () {
    set -e
    [[ ! -e $1 ]] || rm -rf $1
    ensure_dir $1
}


ensure_dir $CACHE_DIR
recreate_dir $STAGING_DIR


progress "=> Updating System..."
sudo pacman -Syuu --noconfirm


if [[ ! $(command -v paru) ]]; then
    progress "=> Installing paru..."
    ensure_dir $CACHE_DIR_PARU
    sudo pacman -S --quiet --needed --noconfirm base-devel git
    git clone --quiet --depth 1 --shallow-submodules https://aur.archlinux.org/paru.git $CACHE_DIR_PARU
    cd $CACHE_DIR_PARU
    makepkg -si --needed --noconfirm
fi


progress "=> Installing AUR dependencies..."
paru -S --quiet --needed --noconfirm $(cat $AUR_FILE)


progress "=> Staging binary crates from cargo..."
cargo install --root $CACHE_DIR_CARGO $(cat $CRATES_FILE)
echo "The above warning regarding $CACHE_DIR_CARGO is irrelevant, as it is only the cache directory. See installation directory below (at the end of the script)."
cp -t $STAGING_DIR $CACHE_DIR_CARGO/bin/*


progress "=> Staging scripts..."
cp -rt $STAGING_DIR $SCRIPTS_DIR/*
find $STAGING_DIR -type f -name "*.*" -execdir bash -c 'mv "$0" "${0%.*}"' {} \;


progress "=> Installing binaries..."
recreate_dir $INSTALL_DIR
cp -rt $INSTALL_DIR $STAGING_DIR/*
chmod +x --recursive $INSTALL_DIR


progress "=> Cleaning up installation files..."
rm -rf $STAGING_DIR


progress "=> Installed iukbtw."
echo -n "Scripts and binaries installed to: "; info "$SCRIPTS_DIR"
notice "Be sure to add the installation directory to your PATH."
