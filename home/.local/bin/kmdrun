#!/bin/bash
set -e

LOG_DIR=/tmp/logs-$USER
CONFIG_DIR=$HOME/.local/share/kmonad
DEVICE_FILE=$HOME/.config/hardware/input
ICON_PATH=$HOME/tux.png
NOTIFY_SYNC_ARG="string:synchronous:kmd"

APP_NAME=$(basename "$0")
ABOUT="Run KMonad."
CLI=(
    --prefix "args_"
    -c "devices;Devices to enable"
    -O "device-file;File of devices to enable;${DEVICE_FILE};d"
    -f "debug;Enable debug mode;;D"
    -f "fail;Fail if a device cannot be enabled"
    -e "kmonad_args;Extra arguments for KMonad"
)
CLI=$(spongecrab --name "$APP_NAME" --about "$ABOUT" "${CLI[@]}" -- "$@") || exit 1
# echo "$CLI" >&2
eval "$CLI" || exit 1

[[ $EUID -eq 0 ]] && exit_error "Do not run $APP_NAME as root."

cd

if [[ -n $args_debug ]]; then
    args_kmonad_args=(-l debug ${args_kmonad_args[@]})
fi

run_kmonad() {
    set -e
    local device_path=$1
    local device_name=$(basename $device_path)
    local sync_arg=${NOTIFY_SYNC_ARG}-$device_name

    # Create (combine) new config file
    mkdir --parents $CONFIG_DIR
    kbd_file=$CONFIG_DIR/$device_name.kbd
    printcolor -ns info "KMonad config file: "; echo $kbd_file
    [[ ! -e $kbd_file ]] || rm -r $kbd_file
    cat $HOME/.config/kmd/* > $kbd_file

    # Insert device path
    sed -i "s|<KMD_DEVICE_PATH>|${device_path}|" $kbd_file
    # Insert start command
    start_command="notify-send -h ${sync_arg} -i ${ICON_PATH} \'Started KMonad\' \'${device_name}\'"
    sed -i "s|<KMD_START_CMD>|${start_command}|" $kbd_file

    # Kill KMonad
    local running_pid=$(pgrep -ax kmonad | grep $device_name | awk '{print $1}' || echo '')
    if [[ -n $running_pid ]]; then
        sleep 0.1
        kill $running_pid
    fi
    # setlayer base

    # Start KMonad
    notify-send -h ${sync_arg} -i ~/tux.png -u low "Starting KMonad..." "$device_name"
    kmonad $kbd_file ${args_kmonad_args[@]} >${LOG_DIR}/${device_name}.log 2>&1 &
}

available_devices=$(find /dev/input/by-* -type l)
printcolor -ns info "Available devices: "; echo $available_devices | wc -w

mapfile devices_from_file <<< $(decomment $args_device_file)

enable_devices=(${args_devices[@]} ${devices_from_file[@]})
printcolor -ns info "Enable devices: "; echo "${#enable_devices[@]}"


for some_device in ${enable_devices[@]} ; do
    device_path=$(echo "$available_devices" | grep $some_device || echo '')
    if [[ -z $device_path ]]; then
        [[ -z $args_fail ]] || exit_error "Device unavailable: $some_device"
        continue
    fi
    printcolor -ns ok "Enabling device: "; printcolor -s info "${some_device}"
    run_kmonad $device_path
done
